<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MBM Quiz Contest 2025 - Team Application Form</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        /* Your existing custom CSS styles go here, adapted for Bootstrap where necessary */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #e0f7fa 0%, #e8f5e9 50%, #e3f2fd 100%);
            background-attachment: fixed;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
        }
        .dotted-line {
            border-bottom: 1px dotted #000;
            flex-grow: 1;
        }
        .form-section-title {
            font-weight: bold;
            text-align: center;
            padding: 1rem 0;
            border-top: 1px solid #000;
            border-bottom: 1px solid #000;
            margin-top: 2rem;
            margin-bottom: 2rem;
            background-color: #e0e0e0;
            font-size: 1.25rem;
            color: #333;
            letter-spacing: 0.05em;
        }
        /* Overriding Bootstrap's default form-control styling for input-field look */
        .form-control.input-field {
            border: 1px solid #d1d5db;
            border-bottom: 2px solid #000;
            outline: none;
            width: 100%;
            padding: 0.5rem 0.75rem;
            background-color: #f9fafb;
            border-radius: 0.375rem;
            transition: all 0.2s ease-in-out;
        }
        .form-control.input-field:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 0.25rem rgba(37, 99, 235, 0.25); /* Bootstrap's shadow equivalent */
            background-color: #fff;
        }
        /* Custom styling for radio/checkbox to mimic original Tailwind look (optional) */
        .form-check-input {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid #6b7280;
            border-radius: 4px;
            display: inline-block;
            position: relative;
            vertical-align: middle;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.2s ease-in-out;
            margin-right: 0.5rem; /* Space between input and label */
        }
        .form-check-input:checked {
            background-color: transparent; /* Keep background transparent for custom checkmark */
            border-color: #6b7280; /* Keep border color consistent */
        }
        .form-check-input[type="checkbox"]:checked::before {
            content: 'âœ”';
            font-size: 14px;
            color: #10b981;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            line-height: 1;
        }
        .form-check-input[type="radio"] {
            border-radius: 50%;
        }
        .form-check-input[type="radio"]:checked {
            background-color: #2563eb;
            border-color: #2563eb;
        }
        .form-check-input[type="radio"]:checked::before {
            content: '';
            background-color: #fff;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: block;
        }

        .form-container {
            border: 1px solid #e5e7eb;
            background-color: #fff;
            padding: 2.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            position: relative;
            border-radius: 1rem;
            max-width: 900px;
            width: 100%;
        }
        /* Participant grid using Bootstrap rows and columns */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #22c55e;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .passport-photo-container {
            width: 120px;
            height: 140px;
            border: 2px dashed #9ca3af;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            cursor: pointer;
            background-color: #f9fafb;
            position: relative;
            margin-bottom: 10px;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
        }
        .passport-photo-container:hover {
            border-color: #60a5fa;
            background-color: #eff6ff;
        }
        .passport-photo-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .passport-photo-container span {
            color: #6b7280;
            font-size: 0.85rem;
            text-align: center;
            padding: 5px;
        }
        .signature-container {
            width: 220px;
            height: 90px;
            border: 2px dashed #9ca3af;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            cursor: pointer;
            background-color: #f9fafb;
            position: relative;
            margin-top: 1.5rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
        }
        .signature-container:hover {
            border-color: #60a5fa;
            background-color: #eff6ff;
        }
        .signature-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .signature-container span {
            color: #6b7280;
            font-size: 0.85rem;
            text-align: center;
            padding: 5px;
        }
        .file-input-hidden {
            display: none;
        }
        .logo-container {
            position: absolute;
            top: 1.5rem;
            left: 1.5rem;
            z-index: 10;
        }
        .logo-container img {
            width: 70px;
            height: auto;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .serial-number {
            position: absolute;
            top: 1.5rem;
            right: 2.5rem;
            font-size: 1.25rem;
            font-weight: bold;
            color: #333;
            z-index: 10;
        }
        @media (max-width: 768px) {
            .logo-container {
                top: 1rem;
                left: 1rem;
            }
            .logo-container img {
                width: 50px;
            }
            body {
                padding: 1rem;
            }
            .form-container {
                padding: 1.5rem;
            }
            .serial-number {
                top: 1rem;
                right: 1.5rem;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body class="p-4 p-md-8">
    <div class="container-fluid form-container rounded-lg">
        <div class="logo-container">
            <img src="MBM logo.png" alt="Company Logo" onerror="this.onerror=null;this.src='https://placehold.co/70x70/ADD8E6/000000?text=LOGO';">
        </div>

        <div id="serialNumberDisplay" class="serial-number"></div>
<form id="applicationForm" autocomplete="off">
        <div class="text-center mb-5 pt-4">
            <h1 class="fs-2 fs-md-1 fw-bolder text-dark mb-2">10th MBM Quiz Contest 2025</h1>
            <p class="fs-6 text-secondary">Team Application Form</p>
            <p class="fs-6 text-muted mt-1">Organised by: MBM News Network</p>
        </div>

        <div class="mb-5 p-4 bg-light rounded-lg border border-secondary-subtle">
            <div class="d-flex flex-column flex-md-row align-items-md-center mb-4">
                <span class="me-md-4 fw-bold text-dark">Select Category :</span>
                <div class="d-flex flex-wrap gap-4 gap-md-5">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="category" value="junior" id="categoryJunior" autocomplete="off" checked>
                        <label class="form-check-label" for="categoryJunior">
                            Junior (class 4th - 8th)
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="category" value="senior" id="categorySenior" autocomplete="off">
                        <label class="form-check-label" for="categorySenior">
                            Senior (class 9th - 12th)
                        </label>
                    </div>
                </div>
            </div>
            <div class="d-flex flex-column flex-md-row align-items-md-center">
    <span class="me-md-4 fw-bold text-dark">Select Exam Centre :</span>
    <div class="row"> <div class="col-6 col-md-4 mb-2"> <div class="form-check">
                <input class="form-check-input" type="radio" name="exam_centre" value="nahan" id="centreNahan" autocomplete="off" checked>
                <label class="form-check-label" for="centreNahan">Nahan</label>
            </div>
        </div>
        <div class="col-6 col-md-4 mb-2">
            <div class="form-check">
                <input class="form-check-input" type="radio" name="exam_centre" value="paonta" id="centrePaonta" autocomplete="off">
                <label class="form-check-label" for="centrePaonta">Paonta</label>
            </div>
        </div>
        <div class="col-6 col-md-4 mb-2">
            <div class="form-check">
                <input class="form-check-input" type="radio" name="exam_centre" value="kafota" id="centreKafota" autocomplete="off">
                <label class="form-check-label" for="centreKafota">Kafota</label>
            </div>
        </div>
        <div class="col-6 col-md-4 mb-2">
            <div class="form-check">
                <input class="form-check-input" type="radio" name="exam_centre" value="shillai" id="centreShillai" autocomplete="off">
                <label class="form-check-label" for="centreShillai">Shillai</label>
            </div>
        </div>
        <div class="col-6 col-md-4 mb-2">
            <div class="form-check">
                <input class="form-check-input" type="radio" name="exam_centre" value="dadahu" id="centreDadahu" autocomplete="off">
                <label class="form-check-label" for="centreDadahu">Dadahu</label>
            </div>
        </div>
        <div class="col-6 col-md-4 mb-2">
            <div class="form-check">
                <input class="form-check-input" type="radio" name="exam_centre" value="rajgarh" id="centreRajgarh" autocomplete="off">
                <label class="form-check-label" for="centreRajgarh">Rajgarh</label>
            </div>
        </div>
        <div class="col-6 col-md-4 mb-2">
            <div class="form-check">
                <input class="form-check-input" type="radio" name="exam_centre" value="sangrah" id="centreSangrah" autocomplete="off">
                <label class="form-check-label" for="centreSangrah">Sangrah</label>
            </div>
        </div>
        <div class="col-6 col-md-4 mb-2">
            <div class="form-check">
                <input class="form-check-input" type="radio" name="exam_centre" value="sarahan" id="centreSarahan" autocomplete="off">
                <label class="form-check-label" for="centreSarahan">Sarahan</label>
            </div>
        </div>
        <div class="col-6 col-md-4 mb-2">
            <div class="form-check">
                <input class="form-check-input" type="radio" name="exam_centre" value="solan" id="centreSolan" autocomplete="off">
                <label class="form-check-label" for="centreSolan">Solan</label>
            </div>
        </div>
    </div>
</div>
        </div>

        <div class="form-section-title">TEAM DETAILS</div>

        <div class="row g-4 mb-5">
            <div class="col-md-6">
                <div class="p-4 border border-secondary-subtle rounded-lg bg-white shadow-sm h-100">
                    <h3 class="fw-bold fs-5 text-dark mb-4 text-center">Participant 1</h3>
                    <div class="d-flex flex-column flex-md-row gap-4">
                        <div class="flex-grow-1 space-y-4">
                            <div class="mb-3">
                                <label for="p1_name" class="form-label text-secondary fw-medium mb-1">Name :</label>
                                <input type="text" id="p1_name" name="p1_name" class="form-control input-field" placeholder="Enter full name" autocomplete="off" required>
                            </div>
                            <div class="mb-3">
                                <label for="p1_class" class="form-label text-secondary fw-medium mb-1">Class :</label>
                                <input type="text" id="p1_class" name="p1_class" class="form-control input-field" placeholder="e.g., 7th, 10th" autocomplete="off" required>
                            </div>
                            <div class="mb-3">
                                <label for="p1_dob" class="form-label text-secondary fw-medium mb-1">D.O.B :</label>
                                <input type="date" id="p1_dob" name="p1_dob" class="form-control input-field" autocomplete="off" required>
                            </div>
                            <div class="mb-3">
                                <label for="p1_school" class="form-label text-secondary fw-medium mb-1">School :</label>
                                <input type="text" id="p1_school" name="p1_school" class="form-control input-field" placeholder="Enter school name" autocomplete="off" required>
                            </div>
                            <div class="mb-3">
                                <label for="p1_parent_mob" class="form-label text-secondary fw-medium mb-1">Mobile No. :</label>
                                <input type="tel" id="p1_parent_mob" name="p1_parent_mob" class="form-control input-field" placeholder="e.g., 9876543210" autocomplete="off" maxlength="10" required>
                            </div>
                            <div class="mb-3">
                                <label for="p1_address" class="form-label text-secondary fw-medium mb-1">Address :</label>
                                <textarea id="p1_address" name="p1_address" rows="3" class="form-control input-field resize-none" placeholder="Enter full address" required></textarea>
                            </div>
                        </div>
                        <div class="flex-shrink-0 d-flex flex-column align-items-center align-items-md-end">
                            <label class="form-label text-secondary fw-medium mb-2">Passport Size Photo :</label>
                            <div class="passport-photo-container" id="p1_photo_container">
                                <span id="p1_photo_text">Click to Upload Photo</span>
                                <img id="p1_photo_preview" src="#" alt="Photo Preview" class="d-none">
                            </div>
                            <input type="file" id="p1_photo" name="p1_photo" accept="image/*" class="file-input-hidden" required>
                        </div>
                    </div>
                    <div class="mb-4 mt-4 d-flex flex-column align-items-center align-items-md-start">
                        <label class="form-label text-secondary fw-medium mb-2">Upload Signature :</label>
                        <div class="signature-container" id="p1_signature_container">
                            <span id="p1_signature_text">Click to Upload Signature</span>
                            <img id="p1_signature_preview" src="#" alt="Signature Preview" class="d-none">
                        </div>
                        <input type="file" id="p1_signature" name="p1_signature" accept="image/*" class="file-input-hidden" required>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="p-4 border border-secondary-subtle rounded-lg bg-white shadow-sm h-100">
                    <h3 class="fw-bold fs-5 text-dark mb-4 text-center">Participant 2</h3>
                    <div class="d-flex flex-column flex-md-row gap-4">
                        <div class="flex-grow-1 space-y-4">
                            <div class="mb-3">
                                <label for="p2_name" class="form-label text-secondary fw-medium mb-1">Name :</label>
                                <input type="text" id="p2_name" name="p2_name" class="form-control input-field" placeholder="Enter full name" autocomplete="off" required>
                            </div>
                            <div class="mb-3">
                                <label for="p2_class" class="form-label text-secondary fw-medium mb-1">Class :</label>
                                <input type="text" id="p2_class" name="p2_class" class="form-control input-field" placeholder="e.g., 7th, 10th" autocomplete="off" required>
                            </div>
                            <div class="mb-3">
                                <label for="p2_dob" class="form-label text-secondary fw-medium mb-1">D.O.B :</label>
                                <input type="date" id="p2_dob" name="p2_dob" class="form-control input-field" autocomplete="off" required>
                            </div>
                            <div class="mb-3">
                                <label for="p2_school" class="form-label text-secondary fw-medium mb-1">School :</label>
                                <input type="text" id="p2_school" name="p2_school" class="form-control input-field" placeholder="Enter school name" autocomplete="off" required>
                            </div>
                            <div class="mb-3">
                                <label for="p2_parent_mob" class="form-label text-secondary fw-medium mb-1">Mobile No. :</label>
                                <input type="tel" id="p2_parent_mob" name="p2_parent_mob" class="form-control input-field" placeholder="e.g., 9876543210" autocomplete="off" maxlength="10" required>
                            </div>
                            <div class="mb-3">
                                <label for="p2_address" class="form-label text-secondary fw-medium mb-1">Address :</label>
                                <textarea id="p2_address" name="p2_address" rows="3" class="form-control input-field resize-none" placeholder="Enter full address" required></textarea>
                            </div>
                        </div>
                        <div class="flex-shrink-0 d-flex flex-column align-items-center align-items-md-end">
                            <label class="form-label text-secondary fw-medium mb-2">Passport Size Photo :</label>
                            <div class="passport-photo-container" id="p2_photo_container">
                                <span id="p2_photo_text">Click to Upload Photo</span>
                                <img id="p2_photo_preview" src="#" alt="Photo Preview" class="d-none">
                            </div>
                            <input type="file" id="p2_photo" name="p2_photo" accept="image/*" class="file-input-hidden" autocomplete="off" required>
                        </div>
                    </div>
                    <div class="mb-4 mt-4 d-flex flex-column align-items-center align-items-md-start">
                        <label class="form-label text-secondary fw-medium mb-2">Upload Signature :</label>
                        <div class="signature-container" id="p2_signature_container">
                            <span id="p2_signature_text">Click to Upload Signature</span>
                            <img id="p2_signature_preview" src="#" alt="Signature Preview" class="d-none">
                        </div>
                        <input type="file" id="p2_signature" name="p2_signature" accept="image/*" class="file-input-hidden" autocomplete="off" required>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-section-title">LUCKY COUPON DETAILS</div>

        <div class="row g-4 mb-5">
            <div class="col-md-6">
                <div class="p-4 border border-secondary-subtle rounded-lg bg-white shadow-sm h-100">
                    <h3 class="fw-bold fs-5 text-dark mb-4 text-center">Participant 1 Lucky Coupon</h3>
                    <div class="space-y-4">
                        <div class="mb-3">
                            <label for="lc_p1_name" class="form-label text-secondary fw-medium mb-1">Name :</label>
                            <input type="text" id="lc_p1_name" name="lc_p1_name" class="form-control input-field" placeholder="Enter full name for coupon" autocomplete="off" required>
                        </div>
                        <div class="mb-3">
                            <label for="lc_p1_mobile" class="form-label text-secondary fw-medium mb-1">Mobile No. :</label>
                            <input type="tel" id="lc_p1_mobile" name="lc_p1_mobile" class="form-control input-field" placeholder="e.g.,  9876543210" autocomplete="off" maxlength="10" required>
                        </div>
                        <div class="mb-3">
                            <label for="lc_p1_fathers_name" class="form-label text-secondary fw-medium mb-1">Parent's Name :</label>
                            <input type="text" id="lc_p1_fathers_name" name="lc_p1_fathers_name" class="form-control input-field" placeholder="Enter Parent's name for coupon" autocomplete="off" required>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="p-4 border border-secondary-subtle rounded-lg bg-white shadow-sm h-100">
                    <h3 class="fw-bold fs-5 text-dark mb-4 text-center">Participant 2 Lucky Coupon</h3>
                    <div class="space-y-4">
                        <div class="mb-3">
                            <label for="lc_p2_name" class="form-label text-secondary fw-medium mb-1">Name :</label>
                            <input type="text" id="lc_p2_name" name="lc_p2_name" class="form-control input-field" placeholder="Enter full name for coupon" autocomplete="off" required>
                        </div>
                        <div class="mb-3">
                            <label for="lc_p2_mobile" class="form-label text-secondary fw-medium mb-1">Mobile No. :</label>
                            <input type="tel" id="lc_p2_mobile" name="lc_p2_mobile" class="form-control input-field" placeholder="e.g.,  9876543210" autocomplete="off" maxlength="10" required>
                        </div>
                        <div class="mb-3">
                            <label for="lc_p2_fathers_name" class="form-label text-secondary fw-medium mb-1">Parent's Name :</label>
                            <input type="text" id="lc_p2_fathers_name" name="lc_p2_fathers_name" class="form-control input-field" placeholder="Enter Parent's name for coupon" autocomplete="off" required>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="text-center mt-5">
            <button type="submit" id="submitButton" class="btn btn-primary btn-lg rounded-pill shadow-lg transition-transform-ease-in-out">
                Submit Application
            </button>
            <div id="message" class="mt-4 fs-6 fw-medium"></div>
        </div>
    </div>
</form>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
  crossorigin="anonymous"></script>



    <script type="module">
       document.getElementById("applicationForm").addEventListener("submit", async function (e) {
  e.preventDefault();
  const formData = Object.fromEntries(new FormData(this).entries());
  const res = await fetch('/api/submit-quiz', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(formData)
  });
  const data = await res.json();
  if (data.success) {
    console.log('Data saved, serial no:', data.serial_number);
  } else {
    alert('Error: ' + data.error);
  }
});


        let currentSerialNumber = null; // To store the generated serial number

        const messageDiv = document.getElementById('message');
        const submitButton = document.getElementById('submitButton');
        const serialNumberDisplay = document.getElementById('serialNumberDisplay');

        // Note: PAYMENT_AMOUNT_INR is no longer directly used for redirection to a payment page,
        // but can be kept for conceptual completeness if you re-introduce payment later.
        const PAYMENT_AMOUNT_INR = 300; 

        // Function to display messages
        function displayMessage(msg, type = 'info') {
            messageDiv.innerHTML = msg; // Use innerHTML for spinner
            messageDiv.className = `mt-4 fs-6 fw-medium ${
                type === 'success' ? 'text-success' :
                type === 'error' ? 'text-danger' :
                'text-secondary'
            }`
            
        }

        // Initialize Supabase client
        function initializeSupabase() {
            try {
                if (SUPABASE_URL === 'YOUR_SUPABASE_PROJECT_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
                    displayMessage("Please replace 'YOUR_SUPABASE_PROJECT_URL' and 'YOUR_SUPABASE_ANON_KEY' in the code with your actual Supabase credentials.", "danger");
                    submitButton.disabled = true;
                    return;
                }
                supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log("Supabase client initialized.");
                displayMessage("Ready to submit application.", "info");
                submitButton.disabled = false; // Enable button once initialized
            } catch (error) {
                console.error("Error initializing Supabase:", error);
                displayMessage(`Error initializing Supabase: ${error.message}`, "danger");
                submitButton.disabled = true;
            }
        }

        async function generateSerialNumber() {
            if (!supabase) {
                console.error("Supabase not initialized for serial number generation.");
                return null;
            }

            try {
                const { data, error } = await supabase
                    .from('serial_numbers')
                    .select('last_serial_number')
                    .order('id', { ascending: false })
                    .limit(1);

                if (error) {
                    throw error;
                }

                let nextNumber = 1;
                if (data && data.length > 0) {
                    const lastNumber = parseInt(data[0].last_serial_number, 10);
                    if (!isNaN(lastNumber)) {
                        nextNumber = lastNumber + 1;
                    }
                }

                if (nextNumber > 2000) {
                    displayMessage("Serial number limit (2000) reached. Cannot generate new serial numbers.", "danger");
                    submitButton.disabled = true;
                    return null;
                }

                const formattedSerialNumber = String(nextNumber).padStart(4, '0');
                return formattedSerialNumber;

            } catch (error) {
                console.error("Error generating serial number:", error);
                if (error.message.includes('relation "public.serial_numbers" does not exist')) {
                    displayMessage("Error: 'serial_numbers' table missing. Please create it in Supabase following the instructions.", "danger");
                } else {
                    displayMessage(`Error generating serial number: ${error.message}`, "danger");
                }
                submitButton.disabled = true;
                return null;
            }
        }

        async function updateLastSerialNumber(serialNumber) {
            if (!supabase) {
                console.error("Supabase not initialized for updating serial number.");
                return;
            }
            try {
                const { error } = await supabase
                    .from('serial_numbers')
                    .upsert({ id: 1, last_serial_number: serialNumber }, { onConflict: 'id' });

                if (error) {
                    throw error;
                }
                console.log(`Last serial number updated to: ${serialNumber}`);
            } catch (error) {
                console.error("Error updating last serial number:", error);
            }
        }

        async function uploadFile(file, bucketName, folderPath) {
            if (!file) return null;

            const fileName = `${currentSerialNumber}-${Date.now()}-${file.name.replace(/\s+/g, '_')}`;
            const filePath = `${folderPath}${fileName}`;

            try {
                const { data, error } = await supabase.storage
                    .from(bucketName)
                    .upload(filePath, file, {
                        cacheControl: '3600',
                        upsert: false
                    });

                if (error) {
                    throw error;
                }

                const { data: publicUrlData } = supabase.storage
                    .from(bucketName)
                    .getPublicUrl(filePath);

                if (publicUrlData && publicUrlData.publicUrl) {
                    return publicUrlData.publicUrl;
                } else {
                    throw new Error("Failed to get public URL for uploaded file.");
                }

            } catch (error) {
                console.error(`Error uploading file to ${bucketName}/${filePath}:`, error);
                return null;
            }
        }

        // Function to handle image preview (for both photos and signatures)
        function handleImagePreview(event, previewId, textSpanId) {
            const file = event.target.files[0];
            const previewImage = document.getElementById(previewId);
            const previewText = document.getElementById(textSpanId);

            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    previewImage.classList.remove('d-none');
                    if (previewText) previewText.classList.add('d-none'); // Hide text when image is present
                };
                reader.readAsDataURL(file);
            } else {
                previewImage.src = '#';
                previewImage.classList.add('d-none');
                if (previewText) previewText.classList.remove('d-none'); // Show text when no image
            }
        }

        async function handleSubmit(event) {
            event.preventDefault();

            // Ask for confirmation
            const confirmationMessage = "Are you sure you want to submit this application? This will generate your receipt directly.";
            if (!confirm(confirmationMessage)) {
                displayMessage("Submission cancelled.", "info");
                return;
            }

            if (!supabase) {
                displayMessage("Supabase client not initialized. Please check your credentials.", "danger");
                return;
            }

            displayMessage('<span class="spinner"></span> Submitting application...', 'info');
            submitButton.disabled = true;

            try {
                currentSerialNumber = await generateSerialNumber();
                if (!currentSerialNumber) {
                    throw new Error("Failed to generate serial number. Submission aborted.");
                }
                serialNumberDisplay.textContent = `S. No. ${currentSerialNumber}`;
                await updateLastSerialNumber(currentSerialNumber);
// Collect form data
const category = document.querySelector('input[name="category"]:checked').value;
const examCentre = document.querySelector('input[name="exam_centre"]:checked').value;

// Participant 1 Data
const p1Name = document.getElementById('p1_name').value;
const p1Class = document.getElementById('p1_class').value;
const p1Dob = document.getElementById('p1_dob').value;
const p1School = document.getElementById('p1_school').value;
const p1ParentMob = document.getElementById('p1_parent_mob').value;
const p1Address = document.getElementById('p1_address').value;
const p1PhotoFile = document.getElementById('p1_photo').files[0];
const p1SignatureFile = document.getElementById('p1_signature').files[0];

// Participant 2 Data
const p2Name = document.getElementById('p2_name').value;
const p2Class = document.getElementById('p2_class').value;
const p2Dob = document.getElementById('p2_dob').value;
const p2School = document.getElementById('p2_school').value;
const p2ParentMob = document.getElementById('p2_parent_mob').value;
const p2Address = document.getElementById('p2_address').value;
const p2PhotoFile = document.getElementById('p2_photo').files[0];
const p2SignatureFile = document.getElementById('p2_signature').files[0];

// Lucky Coupon Data
const lcP1Name = document.getElementById('lc_p1_name').value;
const lcP1Mobile = document.getElementById('lc_p1_mobile').value;
const lcP1FathersName = document.getElementById('lc_p1_fathers_name').value;

const lcP2Name = document.getElementById('lc_p2_name').value;
const lcP2Mobile = document.getElementById('lc_p2_mobile').value;
const lcP2FathersName = document.getElementById('lc_p2_fathers_name').value;

// Upload files to Supabase Storage
// Upload files to Supabase Storage
const p1PhotoUrl = await uploadFile(p1PhotoFile, 'quiz-contest-files', 'photos/participant_photos/');
const p1SignatureUrl = await uploadFile(p1SignatureFile, 'quiz-contest-files', 'signatures/participant_signatures/');
const p2PhotoUrl = await uploadFile(p2PhotoFile, 'quiz-contest-files', 'photos/participant_photos/');
const p2SignatureUrl = await uploadFile(p2SignatureFile, 'quiz-contest-files', 'signatures/participant_signatures/');




// To show warning for photo and signature not uploaded
// document.getElementById("applicationForm").addEventListener("submit", function(e) {
//   const requiredPhotos = ['p1_photo', 'p1_signature', 'p2_photo', 'p2_signature'];
//   for (const id of requiredPhotos) {
//     const input = document.getElementById(id);
//     if (!input.files || input.files.length === 0) {
//       alert(`Please upload the file for: ${id.replace(/_/g, ' ')}`);
//       e.preventDefault();
//       return;
//     }
//   }
// });



// Insert/Update application data with "simulated_paid" status
const { data, error: insertError } = await supabase
    .from('quiz_applications')
    .upsert({
        form_serial_number: currentSerialNumber,
        category: category,
        exam_centre: examCentre,
        p1_name: p1Name,
        p1_class: p1Class,
        p1_dob: p1Dob,
        p1_school: p1School,
        p1_parent_mob: p1ParentMob,           // âœ… Corrected
        p1_address: p1Address,
        p1_photo_url: p1PhotoUrl,
        p1_signature_url: p1SignatureUrl,
        p2_name: p2Name,
        p2_class: p2Class,
        p2_dob: p2Dob,
        p2_school: p2School,
        p2_parent_mob: p2ParentMob,           // âœ… Corrected
        p2_address: p2Address,
        p2_photo_url: p2PhotoUrl,
        p2_signature_url: p2SignatureUrl,
        lc_p1_name: lcP1Name,
        lc_p1_mobile: lcP1Mobile,
        lc_p1_fathers_name: lcP1FathersName,
        lc_p2_name: lcP2Name,
        lc_p2_mobile: lcP2Mobile,
        lc_p2_fathers_name: lcP2FathersName,
        payment_status: 'simulated_paid',
        payment_id: 'SIMULATED-' + Date.now(),
        payment_time: new Date().toISOString(),
        amount_paid: PAYMENT_AMOUNT_INR
    }, { onConflict: 'form_serial_number' })
    .select()
    .single();

                if (insertError) {
                    throw new Error(`Error saving application: ${insertError.message}`);
                }

                displayMessage('Application submitted and payment simulated successfully! Redirecting to receipt...', 'success');
                console.log('Application saved with serial number:', currentSerialNumber, 'and simulated payment status.');

                // Redirect to receipt.html immediately
                setTimeout(() => {
                    window.location.href = `receipt.html?serialNumber=${currentSerialNumber}`;
                }, 1500); // Give a brief moment for the message to display

            } catch (error) {
                console.error('Submission failed:', error);
                displayMessage(`Error: ${error.message}. Please try again.`, 'error');
                submitButton.disabled = false;
            }
        }

        // Event Listeners for file inputs
        document.getElementById('p1_photo_container').addEventListener('click', () => document.getElementById('p1_photo').click());
        document.getElementById('p1_photo').addEventListener('change', (e) => handleImagePreview(e, 'p1_photo_preview', 'p1_photo_text'));

        document.getElementById('p1_signature_container').addEventListener('click', () => document.getElementById('p1_signature').click());
        document.getElementById('p1_signature').addEventListener('change', (e) => handleImagePreview(e, 'p1_signature_preview', 'p1_signature_text'));

        document.getElementById('p2_photo_container').addEventListener('click', () => document.getElementById('p2_photo').click());
        document.getElementById('p2_photo').addEventListener('change', (e) => handleImagePreview(e, 'p2_photo_preview', 'p2_photo_text'));

        document.getElementById('p2_signature_container').addEventListener('click', () => document.getElementById('p2_signature').click());
        document.getElementById('p2_signature').addEventListener('change', (e) => handleImagePreview(e, 'p2_signature_preview', 'p2_signature_text'));

        // Main form submission listener
        document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("applicationForm");
  if (form) {
    form.addEventListener("submit", handleSubmit);
  }
});

        // Initialize Supabase on page load
        initializeSupabase();

        // Generate and display serial number on page load
        window.addEventListener('load', async () => {
            currentSerialNumber = await generateSerialNumber();
            if (currentSerialNumber) {
                serialNumberDisplay.textContent = `S. No. ${currentSerialNumber}`;
            } else {
                serialNumberDisplay.textContent = 'Error fetching S. No.';
            }
        });



    document.getElementById("applicationForm").addEventListener("submit", function(e){
    e.preventDefault();

    let formData = Object.fromEntries(new FormData(this).entries());
    sessionStorage.setItem('quizFormData', JSON.stringify(formData));

    var options = {
        "key": "rzp_test_gNxIJDRvWeuIys",
        "amount": 30000,
        "currency": "INR",
        "name": "MBM Quiz Contest",
        "description": "Registration Fee",
        "handler": function (response){
            window.location.href = "receipt.html?payment_id=" + response.razorpay_payment_id;
        },
        "theme": { "color": "#3399cc" }
    };

    var rzp1 = new Razorpay(options);
    rzp1.open();
});
    </script>
</body>
</html>
